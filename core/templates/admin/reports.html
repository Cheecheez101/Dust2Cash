{% extends 'base.html' %}
{% block title %}Reports — Admin Console{% endblock %}
{% block content %}
<section class="page-info-section">
  <div class="container">
    <h2>Reports & Exports</h2>
    <div class="site-beradcamb">
      <a href="/console/">Admin</a>
      <span><i class="fa fa-angle-right"></i> Reports</span>
    </div>
  </div>
</section>
<section class="spad">
  <div class="container">
    <div class="row g-4 mb-5">
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5>Client roster</h5>
            <p class="text-muted">Full list of registered clients with contact info.</p>
            <a href="{% url 'export_clients_csv' %}" class="btn btn-outline-primary btn-sm">Download CSV</a>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5>Agent roster</h5>
            <p class="text-muted">Agents, availability, and last online times.</p>
            <a href="{% url 'export_agents_csv' %}" class="btn btn-outline-primary btn-sm">Download CSV</a>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5>Transaction log</h5>
            <p class="text-muted">All conversions with status and payout data.</p>
            <a href="{% url 'export_transactions_csv' %}" class="btn btn-outline-primary btn-sm">Download CSV</a>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5>Verification summary</h5>
            <p class="text-muted">Phone & ID completion status.</p>
            <ul class="list-unstyled mb-0 small text-muted">
              <li>Verified clients: {{ verified_summary.verified|default:0 }}</li>
              <li>Pending verification: {{ verified_summary.pending|default:0 }}</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Clients preview</h5>
              <a href="{% url 'export_clients_csv' %}" class="btn btn-outline-primary btn-sm">Download full CSV</a>
            </div>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Created</th>
                  </tr>
                </thead>
                <tbody>
                  {% for client in clients_preview %}
                  <tr>
                    <td>{{ client.first_name }} {{ client.last_name }}</td>
                    <td>{{ client.email }}</td>
                    <td>{{ client.phone_number }}</td>
                    <td>{{ client.created_at|date:"M d, Y H:i" }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="4" class="text-muted">No clients found.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Agents preview</h5>
              <a href="{% url 'export_agents_csv' %}" class="btn btn-outline-primary btn-sm">Download full CSV</a>
            </div>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Username</th>
                    <th>Status</th>
                    <th>Last Online</th>
                  </tr>
                </thead>
                <tbody>
                  {% for agent in agents_preview %}
                  <tr>
                    <td>{{ agent.user.get_full_name|default:agent.user.username }}</td>
                    <td>{{ agent.user.username }}</td>
                    <td>
                      {% if agent.is_online %}
                        <span class="badge bg-success">Online</span>
                      {% else %}
                        <span class="badge bg-secondary">Offline</span>
                      {% endif %}
                    </td>
                    <td>{{ agent.last_online|date:"M d, Y H:i"|default:'—' }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="4" class="text-muted">No agents found.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-3 gap-3">
              <div>
                <h5 class="mb-1">Transactions preview</h5>
                <small class="text-muted">Filtering the 50 most recent entries.</small>
              </div>
              <form method="get" class="row g-2 align-items-end">
                <div class="col-auto">
                  <label class="form-label mb-1">Status</label>
                  <select name="status" class="form-select form-select-sm">
                    <option value="">All</option>
                    {% for value,label in transaction_status_choices %}
                      <option value="{{ value }}" {% if active_filters.status == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-auto">
                  <label class="form-label mb-1">Platform</label>
                  <select name="platform" class="form-select form-select-sm">
                    <option value="">All</option>
                    {% for value,label in transaction_platform_choices %}
                      <option value="{{ value }}" {% if active_filters.platform == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-auto d-flex gap-2">
                  <button class="btn btn-primary btn-sm" type="submit">Apply</button>
                  <a href="{% url 'admin_reports' %}" class="btn btn-outline-secondary btn-sm">Reset</a>
                </div>
              </form>
            </div>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Client</th>
                    <th>Agent</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Created</th>
                  </tr>
                </thead>
                <tbody>
                  {% for tx in transactions_preview %}
                  <tr>
                    <td>#{{ tx.id }}</td>
                    <td>{{ tx.client }}</td>
                    <td>{{ tx.agent|default:'—' }}</td>
                    <td>{{ tx.amount }} {{ tx.get_currency_display }}</td>
                    <td><span class="badge bg-light text-dark">{{ tx.get_status_display }}</span></td>
                    <td>{{ tx.created_at|date:"M d, Y H:i" }}</td>
                  </tr>
                  {% empty %}
                  <tr><td colspan="6" class="text-muted">No transactions found.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}
