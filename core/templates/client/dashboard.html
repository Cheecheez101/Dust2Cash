<!doctype html>
{% extends 'base.html' %}
{% load static %}

{% block title %}Client Dashboard Â· Dust2Cash{% endblock %}
{% block body_class %}dashboard-body{% endblock %}

{% block content %}
<nav class="navbar dashboard-nav bg-white shadow-sm">
  <div class="nav-inner container">
    <a class="nav-identity" href="/">
      <img src="{% static 'img/dust2cashlogo.png' %}" alt="Dust2Cash logo">
      <div>
        <strong>Dust2Cash</strong>
        <div class="text-muted small">Client workspace</div>
      </div>
    </a>
    <div class="nav-actions">
      <span class="status-pill info">Active</span>
      <a class="nav-pill nav-pill--ghost" href="{% url 'client_dashboard' %}">Dashboard</a>
      <a class="nav-pill nav-pill--ghost" href="{% url 'client_profile' %}">Profile</a>
      <a class="nav-pill nav-pill--ghost" href="{% url 'change_password' %}">Password</a>
      <a class="nav-pill nav-pill--danger" href="{% url 'logout' %}">Logout</a>
    </div>
  </div>
</nav>

<main class="dashboard-shell py-4">
  <div class="dashboard-layout">
    <aside class="dashboard-sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">Quick links</div>
        <div class="sidebar-nav nav flex-column gap-2">
          <a class="nav-link {% if request.resolver_match.url_name == 'client_dashboard' %}active{% endif %}" href="{% url 'client_dashboard' %}">Overview</a>
          <a class="nav-link" href="{% url 'create_transaction' %}">New Transaction</a>
          <a class="nav-link" href="{% url 'client_profile' %}">Profile</a>
          <a class="nav-link" href="{% url 'change_password' %}">Security</a>
        </div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">Support</div>
        <p class="small text-muted mb-2">Need help? Ping our team via Chatwoot or WhatsApp.</p>
        <a href="mailto:support@dust2cash.com" class="btn btn-sm btn-outline-secondary w-100">Email Support</a>
      </div>
    </aside>

    <div class="flex-grow-1">
      <section class="card-bleed mb-4">
        <div class="d-flex flex-column flex-lg-row justify-content-between gap-4">
          <div>
            <div class="hero-title">Hello {{ profile.first_name }} ðŸ‘‹</div>
            <p class="hero-subtitle">Stay on top of your conversions, monitor agent availability, and move funds at the live exchange rate.</p>
            <div class="metric-group">
              <span class="metric-chip">Live Rate <strong>1&nbsp;USDT = KSH {{ pricing.exchange_rate }}</strong></span>
              <span class="metric-chip">Fee {{ pricing.transaction_fee_percent }}%</span>
            </div>
            <div class="hero-cta">
              <a href="{% url 'create_transaction' %}" class="btn btn-gold">Create Transaction</a>
              <a href="{% url 'client_profile' %}" class="btn btn-outline-light">Complete Profile</a>
            </div>
          </div>
          <div class="text-lg-end">
            <div class="stat-label">Account Completion</div>
            <div class="stat-value mb-2">{{ profile.completeness|default:82 }}%</div>
            <p class="mb-0 opacity-75">Upload ID + Verify phone to unlock higher limits.</p>
          </div>
        </div>
      </section>

      {% if agent_online %}
        <div class="alert-banner bg-success-subtle text-success mb-4">
          <span>Agent online &mdash; start a transaction and get instant support.</span>
          <a href="{% url 'create_transaction' %}" class="btn btn-sm btn-success">New Transaction</a>
        </div>
      {% else %}
        <div class="alert-banner bg-warning-subtle text-warning mb-4">
          <span>No agent is online right now. Capture your transaction and we will ping you once someone is available.</span>
          {% if requestable_transaction %}
            <a href="{% url 'request_agent' requestable_transaction.id %}" class="btn btn-sm btn-warning">Notify Agents</a>
          {% else %}
            <a href="{% url 'create_transaction' %}" class="btn btn-sm btn-warning">Create Transaction</a>
          {% endif %}
        </div>
      {% endif %}

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}

      <section class="dashboard-grid mb-4">
        <div class="stat-card">
          <div class="stat-label">Transactions</div>
          <div class="stat-value">{{ transactions|length }}</div>
          <small class="text-muted">Lifetime conversions</small>
        </div>
        <div class="stat-card">
          <div class="stat-label">Pending</div>
          <div class="stat-value">{{ transactions|dictsort:"status"|length }}</div>
          <small class="text-muted">Awaiting actions</small>
        </div>
        <div class="stat-card">
          <div class="stat-label">Last Amount</div>
          <div class="stat-value">{% if requestable_transaction %}{{ requestable_transaction.amount }} {{ requestable_transaction.get_currency_display }}{% else %}&mdash;{% endif %}</div>
          <small class="text-muted">Most recent request</small>
        </div>
      </section>

      <section class="dashboard-card">
        <div class="section-heading">
          <h5>Your Transactions</h5>
          <span class="auto-refresh">Updated {{ transactions.0.created_at|timesince }} ago</span>
        </div>

        {% if transactions %}
          <div class="table-responsive">
            <table class="table dashboard-table align-middle">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Platform</th>
                  <th>Amount</th>
                  <th>To Receive</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for transaction in transactions %}
                <tr>
                  <td>{{ transaction.created_at|date:"M d, Y" }}</td>
                  <td>{{ transaction.get_platform_display }}</td>
                  <td>{{ transaction.amount }} {{ transaction.get_currency_display }}</td>
                  <td>KSH {{ transaction.amount_to_receive }}</td>
                  <td>
                    <span class="status-pill {% if transaction.status == 'completed' %}success{% elif transaction.status == 'pending' %}warning{% else %}info{% endif %}">
                      {{ transaction.get_status_display }}
                    </span>
                  </td>
                  <td>
                    {% if transaction.status == 'agent_online' or transaction.status == 'address_provided' %}
                      <a href="{% url 'request_address' transaction.id %}" class="btn btn-sm btn-outline-primary">View</a>
                    {% elif transaction.status == 'pending' %}
                      <a href="{% url 'request_agent' transaction.id %}" class="btn btn-sm btn-outline-warning">Request Agent</a>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">No transactions yet. Create your first transaction to get started!</p>
        {% endif %}
      </section>
    </div>
  </div>
</main>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
  window.chatwootSettings = {"position":"right","type":"standard","launcherTitle":"Chat with us"};
  (function(d,t) {
    var BASE_URL="https://app.chatwoot.com";
    var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=BASE_URL+"/packs/js/sdk.js";
    g.async = true;
    s.parentNode.insertBefore(g,s);
    g.onload=function(){
      window.chatwootSDK.run({
        websiteToken: 'RYRXUpMGqFPFwnxkh5hYvrQF',
        baseUrl: BASE_URL
      })
    }
  })(document,"script");
</script>
{% endblock %}
